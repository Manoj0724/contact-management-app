<!-- PAGE HEADER -->
<div class="page-header fade-in">
  <div class="page-title">
    <h1>Edit Contact</h1>
    <p>Update the contact details below</p>
  </div>
  <button mat-stroked-button (click)="cancel()" class="btn-icon">
    <mat-icon>arrow_back</mat-icon>
    Back to Contacts
  </button>
</div>

<div class="form-card fade-in">

  <!-- FORM HEADER -->
  <div class="form-header">
    <div>
      <h2>Update Contact Information</h2>
      <p>All fields marked with * are required</p>
    </div>
    <mat-icon style="color:rgba(255,255,255,0.4);font-size:48px;width:48px;height:48px;">
      edit
    </mat-icon>
  </div>

  <!-- LOADING CONTACT -->
  <div *ngIf="loading" style="padding:60px;text-align:center;">
    <mat-spinner style="margin:0 auto;"></mat-spinner>
    <p style="margin-top:16px;color:var(--text-secondary);">Loading contact...</p>
  </div>

  <!-- ERROR -->
  <div *ngIf="errorMessage && !loading" style="padding:40px;text-align:center;color:#ef4444;">
    <mat-icon style="font-size:48px;width:48px;height:48px;">error_outline</mat-icon>
    <p>{{ errorMessage }}</p>
    <button mat-raised-button color="primary" (click)="cancel()">Go Back</button>
  </div>

  <!-- MAIN FORM -->
  <form #contactForm="ngForm" *ngIf="!loading && !errorMessage">

    <div class="form-body">

      <!-- ======================== -->
      <!-- PERSONAL INFO            -->
      <!-- ======================== -->
      <div class="section-label">üë§ Personal Information</div>
      <div class="row mb-4">

        <!-- TITLE -->
        <div class="col-md-2 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>Title *</mat-label>
            <mat-select name="title" [(ngModel)]="form.title" required #title="ngModel">
              <mat-option value="">Select</mat-option>
              <mat-option value="Mr">Mr</mat-option>
              <mat-option value="Mrs">Mrs</mat-option>
              <mat-option value="Ms">Ms</mat-option>
              <mat-option value="Dr">Dr</mat-option>
            </mat-select>
            <mat-error *ngIf="title.invalid && title.touched">Required</mat-error>
          </mat-form-field>
        </div>

        <!-- FIRST NAME -->
        <div class="col-md-5 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>First Name *</mat-label>
            <input matInput name="firstName" [(ngModel)]="form.firstName"
              required pattern="^[a-zA-Z\s]+$" #firstName="ngModel"
              placeholder="Enter first name"/>
            <mat-icon matPrefix>person</mat-icon>
            <mat-error *ngIf="firstName.errors?.['required'] && firstName.touched">
              First name is required
            </mat-error>
            <mat-error *ngIf="firstName.errors?.['pattern'] && firstName.touched">
              Only letters allowed
            </mat-error>
          </mat-form-field>
        </div>

        <!-- LAST NAME -->
        <div class="col-md-5 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>Last Name *</mat-label>
            <input matInput name="lastName" [(ngModel)]="form.lastName"
              required pattern="^[a-zA-Z\s]+$" #lastName="ngModel"
              placeholder="Enter last name"/>
            <mat-error *ngIf="lastName.errors?.['required'] && lastName.touched">
              Last name is required
            </mat-error>
            <mat-error *ngIf="lastName.errors?.['pattern'] && lastName.touched">
              Only letters allowed
            </mat-error>
          </mat-form-field>
        </div>

      </div>

      <!-- ======================== -->
      <!-- CONTACT DETAILS          -->
      <!-- ======================== -->
      <div class="section-label">üì± Contact Details</div>
      <div class="row mb-4">

        <!-- MOBILE 1 -->
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>Mobile 1 *</mat-label>
            <input matInput name="mobile1" [(ngModel)]="form.mobile1"
              required pattern="^[0-9]{10}$" maxlength="10"
              #mobile1="ngModel" placeholder="10-digit number"/>
            <mat-icon matPrefix>phone</mat-icon>
            <mat-error *ngIf="mobile1.errors?.['required'] && mobile1.touched">
              Mobile is required
            </mat-error>
            <mat-error *ngIf="mobile1.errors?.['pattern'] && mobile1.touched">
              Must be exactly 10 digits
            </mat-error>
          </mat-form-field>
        </div>

        <!-- MOBILE 2 -->
        <div class="col-md-6 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>Mobile 2 (Optional)</mat-label>
            <input matInput name="mobile2" [(ngModel)]="form.mobile2"
              pattern="^[0-9]{10}$" maxlength="10"
              #mobile2="ngModel" placeholder="10-digit number"/>
            <mat-icon matPrefix>phone_iphone</mat-icon>
            <mat-error *ngIf="mobile2.errors?.['pattern'] && mobile2.touched">
              Must be exactly 10 digits
            </mat-error>
          </mat-form-field>
        </div>

      </div>

      <!-- ======================== -->
      <!-- ADDRESS                  -->
      <!-- ======================== -->
      <div class="section-label">üìç Address Details</div>
      <div class="row mb-4">

        <!-- CITY -->
        <div class="col-md-4 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>City *</mat-label>
            <input matInput name="city" [(ngModel)]="form.city"
              required pattern="^[a-zA-Z\s]+$" #city="ngModel"
              placeholder="Enter city"/>
            <mat-icon matPrefix>location_city</mat-icon>
            <mat-error *ngIf="city.errors?.['required'] && city.touched">
              City is required
            </mat-error>
            <mat-error *ngIf="city.errors?.['pattern'] && city.touched">
              Only letters allowed
            </mat-error>
          </mat-form-field>
        </div>

        <!-- STATE -->
        <div class="col-md-4 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>State *</mat-label>
            <input matInput name="state" [(ngModel)]="form.state"
              required pattern="^[a-zA-Z\s]+$" #state="ngModel"
              placeholder="Enter state"/>
            <mat-icon matPrefix>map</mat-icon>
            <mat-error *ngIf="state.errors?.['required'] && state.touched">
              State is required
            </mat-error>
            <mat-error *ngIf="state.errors?.['pattern'] && state.touched">
              Only letters allowed
            </mat-error>
          </mat-form-field>
        </div>

        <!-- PINCODE -->
        <div class="col-md-4 mb-3">
          <mat-form-field appearance="outline">
            <mat-label>Pincode *</mat-label>
            <input matInput name="pincode" [(ngModel)]="form.pincode"
              required pattern="^[0-9]{6}$" maxlength="6"
              #pincode="ngModel" placeholder="6-digit code"/>
            <mat-icon matPrefix>pin</mat-icon>
            <mat-error *ngIf="pincode.errors?.['required'] && pincode.touched">
              Pincode is required
            </mat-error>
            <mat-error *ngIf="pincode.errors?.['pattern'] && pincode.touched">
              Must be 6 digits
            </mat-error>
          </mat-form-field>
        </div>

      </div>

      <!-- ======================== -->
      <!-- GROUPS SECTION           -->
      <!-- ======================== -->
      <div class="section-label">üè∑Ô∏è Assign to Groups</div>
      <div class="groups-section">

        <!-- SPINNER: show while loading groups -->
        <div *ngIf="groupsLoading" class="groups-loading">
          <mat-spinner diameter="24"></mat-spinner>
          <span>Loading groups...</span>
        </div>

        <!-- NO GROUPS: only show AFTER loading finishes -->
        <div *ngIf="!groupsLoading && allGroups.length === 0"
             class="groups-empty-state">
          <div class="empty-groups-icon">
            <mat-icon>label_off</mat-icon>
          </div>
          <p>No groups yet</p>
          <small>Create groups from the sidebar to organize contacts</small>
        </div>

        <!-- GROUPS CHIPS: show after loading, when groups exist -->
        <div *ngIf="!groupsLoading && allGroups.length > 0"
             class="groups-grid">
          <div
            *ngFor="let group of allGroups"
            class="group-chip"
            [class.group-chip-selected]="isGroupSelected(group._id)"
            [style.border-color]="isGroupSelected(group._id) ? group.color : '#e5e7eb'"
            [style.background]="isGroupSelected(group._id) ? group.color + '18' : 'white'"
            (click)="toggleGroup(group._id)">

            <!-- COLOR DOT -->
            <span class="group-chip-dot" [style.background]="group.color"></span>

            <!-- NAME -->
            <span class="group-chip-name">{{ group.name }}</span>

            <!-- CHECKMARK when selected -->
            <mat-icon
              *ngIf="isGroupSelected(group._id)"
              class="group-chip-check"
              [style.color]="group.color">
              check_circle
            </mat-icon>

          </div>
        </div>

        <!-- SUMMARY: show selected group names -->
        <div *ngIf="!groupsLoading && selectedGroupIds.length > 0"
             class="groups-selected-info">
          <mat-icon>check_circle</mat-icon>
          <span>
            Assigned to
            <strong>{{ selectedGroupIds.length }}</strong>
            group{{ selectedGroupIds.length > 1 ? 's' : '' }}:
            <span *ngFor="let id of selectedGroupIds; let last = last">
              <strong>{{ getGroupName(id) }}</strong>{{ !last ? ', ' : '' }}
            </span>
          </span>
        </div>

      </div>
      <!-- END GROUPS SECTION -->

    </div>
    <!-- END FORM BODY -->

    <!-- FORM FOOTER -->
    <div class="form-footer">
      <button mat-stroked-button type="button" (click)="cancel()">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="onUpdate()"
        [disabled]="contactForm.invalid">
        <mat-icon>save</mat-icon>
        Update Contact
      </button>
    </div>

  </form>

</div>
