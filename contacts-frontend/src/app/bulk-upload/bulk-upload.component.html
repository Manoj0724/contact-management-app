<!-- ===================================================================================== -->
<!-- FILE: src/app/bulk-upload/bulk-upload.component.html                                -->
<!-- ===================================================================================== -->

<div class="bulk-page">

  <!-- ======== PAGE HEADER ======== -->
  <div class="bulk-header">
    <div class="bulk-header-left">
      <button class="back-btn" (click)="goToContacts()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div>
        <h1>Bulk Upload Contacts</h1>
        <p>Upload hundreds of contacts at once via CSV or manual entry</p>
      </div>
    </div>
    <button class="template-btn" (click)="downloadTemplate()">
      <mat-icon>download</mat-icon>
      Download Template
    </button>
  </div>

  <!-- ======== STEP INDICATOR ======== -->
  <div class="step-indicator">
    <div class="step" [class.active]="step === 'upload'" [class.done]="step !== 'upload'">
      <div class="step-circle">
        <mat-icon *ngIf="step !== 'upload'">check</mat-icon>
        <span *ngIf="step === 'upload'">1</span>
      </div>
      <span>Upload File</span>
    </div>
    <div class="step-line" [class.done]="step !== 'upload'"></div>
    <div class="step" [class.active]="step === 'preview'" [class.done]="step === 'result'">
      <div class="step-circle">
        <mat-icon *ngIf="step === 'result'">check</mat-icon>
        <span *ngIf="step !== 'result'">2</span>
      </div>
      <span>Preview & Edit</span>
    </div>
    <div class="step-line" [class.done]="step === 'result'"></div>
    <div class="step" [class.active]="step === 'result'">
      <div class="step-circle">3</div>
      <span>Results</span>
    </div>
  </div>

  <!-- ============================================================ -->
  <!-- STEP 1: UPLOAD                                               -->
  <!-- ============================================================ -->
  <div class="step-content" *ngIf="step === 'upload'">

    <!-- ✅ NEW: TEMPLATE PREVIEW CARD -->
    <div class="template-card">
      <div class="template-header" (click)="toggleTemplatePreview()">
        <div class="template-title">
          <mat-icon>description</mat-icon>
          <div>
            <h3>CSV Template Format</h3>
            <p>Click to {{ showTemplatePreview ? 'hide' : 'view' }} required columns and sample data</p>
          </div>
        </div>
        <button class="expand-btn" [class.expanded]="showTemplatePreview">
          <mat-icon>{{ showTemplatePreview ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <!-- EXPANDABLE CONTENT -->
      <div class="template-body" *ngIf="showTemplatePreview">

        <!-- SAMPLE DATA TABLE -->
        <div class="template-section">
          <h4><mat-icon>table_chart</mat-icon> Sample CSV Data</h4>
          <div class="template-table-wrapper">
            <table class="template-table">
              <thead>
                <tr>
                  <th *ngFor="let header of CSV_TEMPLATE_HEADERS">{{ header }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of CSV_SAMPLE_ROWS">
                  <td *ngFor="let cell of row">{{ cell }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- VALIDATION RULES -->
        <div class="template-section">
          <h4><mat-icon>check_circle</mat-icon> Validation Rules</h4>
          <div class="rules-list">
            <div class="rule-item" *ngFor="let rule of VALIDATION_RULES">
              <div class="rule-header">
                <span class="rule-field">
                  {{ rule.field }}
                  <span class="required-badge" *ngIf="rule.required">required</span>
                  <span class="optional-badge" *ngIf="!rule.required">optional</span>
                </span>
              </div>
              <div class="rule-details">
                <span class="rule-text">{{ rule.rule }}</span>
                <code class="rule-example">{{ rule.example }}</code>
              </div>
            </div>
          </div>
        </div>

        <!-- TIPS -->
        <div class="template-tips">
          <mat-icon>lightbulb</mat-icon>
          <div>
            <strong>Pro Tips:</strong>
            <ul>
              <li>Column names are case-insensitive (firstName = firstname = FIRSTNAME)</li>
              <li>Empty cells are allowed for optional fields like mobile2</li>
              <li>Maximum 500 contacts per upload</li>
              <li>Use Excel, Google Sheets, or any CSV editor</li>
            </ul>
          </div>
        </div>

      </div>
    </div>

    <!-- UPLOAD ZONE -->
    <div
      class="drop-zone"
      [class.dragging]="isDragging"
      (dragover)="onDragOver($event)"
      (dragleave)="onDragLeave($event)"
      (drop)="onDrop($event)">

      <div class="drop-icon">
        <mat-icon>cloud_upload</mat-icon>
      </div>
      <h2>Drag & Drop your CSV file here</h2>
      <p>Supports CSV files up to 5MB — max 500 contacts</p>

      <div class="drop-actions">
        <label class="file-select-btn">
          <mat-icon>folder_open</mat-icon>
          Browse File
          <input type="file" accept=".csv" (change)="onFileSelect($event)" hidden>
        </label>
        <span class="or-divider">or</span>
        <button class="manual-btn" (click)="useManualEntry()">
          <mat-icon>edit_note</mat-icon>
          Enter Manually
        </button>
      </div>

      <div class="parse-error" *ngIf="parseError">
        <mat-icon>error</mat-icon>
        {{ parseError }}
      </div>
    </div>

    <!-- HOW IT WORKS -->
    <div class="how-it-works">
      <h3>How it works</h3>
      <div class="steps-grid">
        <div class="how-step">
          <div class="how-num">1</div>
          <div>
            <strong>Download Template</strong>
            <p>Get the CSV template with correct columns</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-num">2</div>
          <div>
            <strong>Fill in Contacts</strong>
            <p>Add your contacts — title, name, mobile, city etc.</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-num">3</div>
          <div>
            <strong>Upload & Review</strong>
            <p>Preview data, fix errors, then upload</p>
          </div>
        </div>
        <div class="how-step">
          <div class="how-num">4</div>
          <div>
            <strong>Done!</strong>
            <p>Contacts are saved and ready to use</p>
          </div>
        </div>
      </div>
    </div>

    <!-- REQUIRED COLUMNS + TEMPLATE PREVIEW -->
<div class="columns-info">
  <div class="columns-header">
    <h3>Required CSV Columns</h3>
    <button class="mini-download-btn" (click)="downloadTemplate()">
      <mat-icon>download</mat-icon>
      Get Template
    </button>
  </div>

  <div class="columns-grid">
    <div class="col-badge required">title <span>Mr/Mrs/Ms/Dr</span></div>
    <div class="col-badge required">firstName</div>
    <div class="col-badge required">lastName</div>
    <div class="col-badge required">mobile1 <span>10 digits</span></div>
    <div class="col-badge optional">mobile2 <span>optional</span></div>
    <div class="col-badge required">city</div>
    <div class="col-badge required">state</div>
    <div class="col-badge required">pincode <span>6 digits</span></div>
  </div>

  <!-- ✅ NEW: TEMPLATE PREVIEW TABLE -->
  <div class="template-preview">
    <div class="template-preview-header">
      <mat-icon>table_chart</mat-icon>
      <span>Template Preview</span>
    </div>
    <div class="template-table-scroll">
      <table class="template-table">
        <thead>
          <tr>
            <th>title</th>
            <th>firstName</th>
            <th>lastName</th>
            <th>mobile1</th>
            <th>mobile2</th>
            <th>city</th>
            <th>state</th>
            <th>pincode</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Mr</td>
            <td>John</td>
            <td>Smith</td>
            <td>9876543210</td>
            <td>9876543211</td>
            <td>Mumbai</td>
            <td>Maharashtra</td>
            <td>400001</td>
          </tr>
          <tr>
            <td>Mrs</td>
            <td>Priya</td>
            <td>Sharma</td>
            <td>8765432109</td>
            <td></td>
            <td>Delhi</td>
            <td>Delhi</td>
            <td>110001</td>
          </tr>
          <tr>
            <td>Dr</td>
            <td>Arjun</td>
            <td>Patel</td>
            <td>7654321098</td>
            <td>7654321099</td>
            <td>Bangalore</td>
            <td>Karnataka</td>
            <td>560001</td>
          </tr>
          <tr>
            <td>Ms</td>
            <td>Sneha</td>
            <td>Iyer</td>
            <td>6543210987</td>
            <td></td>
            <td>Chennai</td>
            <td>Tamil Nadu</td>
            <td>600001</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="template-preview-footer">
      <mat-icon>info</mat-icon>
      <span>Copy this format when creating your CSV file. Empty cells (like mobile2) are optional.</span>
    </div>
  </div>
</div>

  </div>

  <!-- ============================================================ -->
  <!-- STEP 2: PREVIEW & EDIT                                       -->
  <!-- ============================================================ -->
  <div class="step-content" *ngIf="step === 'preview'">

    <div class="preview-header">
      <div class="preview-info">
        <mat-icon>table_chart</mat-icon>
        <div>
          <strong>{{ fileName }}</strong>
          <span>{{ validRowCount }} contacts ready to upload</span>
        </div>
      </div>
      <div class="preview-actions">
        <button class="btn-secondary" (click)="reset()">
          <mat-icon>refresh</mat-icon>
          Start Over
        </button>
        <button class="btn-add-row" (click)="addRow()">
          <mat-icon>add</mat-icon>
          Add Row
        </button>
        <button class="btn-upload" (click)="uploadContacts()" [disabled]="uploading">
          <mat-icon>{{ uploading ? 'hourglass_empty' : 'cloud_upload' }}</mat-icon>
          {{ uploading ? 'Uploading...' : 'Upload ' + validRowCount + ' Contacts' }}
        </button>
      </div>
    </div>

    <!-- PROGRESS BAR WHILE UPLOADING -->
    <mat-progress-bar *ngIf="uploading" mode="indeterminate" class="upload-progress"></mat-progress-bar>

    <!-- EDITABLE TABLE -->
    <div class="table-scroll">
      <table class="preview-table">
        <thead>
          <tr>
            <th class="row-num">#</th>
            <th>Title *</th>
            <th>First Name *</th>
            <th>Last Name *</th>
            <th>Mobile 1 * <small>(10 digits)</small></th>
            <th>Mobile 2 <small>(optional)</small></th>
            <th>City *</th>
            <th>State *</th>
            <th>Pincode * <small>(6 digits)</small></th>
            <th class="action-col"></th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of parsedContacts; let i = index" class="data-row">
            <td class="row-num">{{ i + 1 }}</td>

            <!-- TITLE -->
            <td>
              <select class="cell-select" [(ngModel)]="row.title">
                <option value="">Select</option>
                <option *ngFor="let t of titles" [value]="t">{{ t }}</option>
              </select>
            </td>

            <!-- FIRST NAME -->
            <td>
              <input class="cell-input" [(ngModel)]="row.firstName"
                placeholder="First name" maxlength="50"/>
            </td>

            <!-- LAST NAME -->
            <td>
              <input class="cell-input" [(ngModel)]="row.lastName"
                placeholder="Last name" maxlength="50"/>
            </td>

            <!-- MOBILE 1 -->
            <td>
              <input class="cell-input" [(ngModel)]="row.mobile1"
                placeholder="9876543210" maxlength="10"/>
            </td>

            <!-- MOBILE 2 -->
            <td>
              <input class="cell-input" [(ngModel)]="row.mobile2"
                placeholder="Optional" maxlength="10"/>
            </td>

            <!-- CITY -->
            <td>
              <input class="cell-input" [(ngModel)]="row.city"
                placeholder="City" maxlength="50"/>
            </td>

            <!-- STATE -->
            <td>
              <input class="cell-input" [(ngModel)]="row.state"
                placeholder="State" maxlength="50"/>
            </td>

            <!-- PINCODE -->
            <td>
              <input class="cell-input" [(ngModel)]="row.pincode"
                placeholder="400001" maxlength="6"/>
            </td>

            <!-- DELETE ROW -->
            <td class="action-col">
              <button class="delete-row-btn" (click)="removeRow(i)"
                matTooltip="Remove row">
                <mat-icon>close</mat-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="table-footer">
      <button class="btn-add-row-bottom" (click)="addRow()">
        <mat-icon>add_circle</mat-icon>
        Add another row
      </button>
      <span class="row-count">{{ parsedContacts.length }} rows total</span>
    </div>

  </div>

  <!-- ============================================================ -->
  <!-- STEP 3: RESULT                                               -->
  <!-- ============================================================ -->
  <div class="step-content" *ngIf="step === 'result' && uploadResult">

    <!-- SUCCESS BANNER -->
    <div class="result-banner" [class.full-success]="uploadResult.failed === 0"
         [class.partial]="uploadResult.failed > 0 && uploadResult.uploaded > 0"
         [class.full-fail]="uploadResult.uploaded === 0">

      <div class="result-icon">
        <mat-icon *ngIf="uploadResult.failed === 0">check_circle</mat-icon>
        <mat-icon *ngIf="uploadResult.uploaded === 0">cancel</mat-icon>
        <mat-icon *ngIf="uploadResult.uploaded > 0 && uploadResult.failed > 0">warning</mat-icon>
      </div>
      <div class="result-text">
        <h2 *ngIf="uploadResult.failed === 0">All contacts uploaded successfully!</h2>
        <h2 *ngIf="uploadResult.uploaded === 0">Upload failed</h2>
        <h2 *ngIf="uploadResult.uploaded > 0 && uploadResult.failed > 0">Upload completed with some errors</h2>
        <p>{{ uploadResult.uploaded }} of {{ uploadResult.total }} contacts saved</p>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="result-stats">
      <div class="stat-card success-card">
        <div class="stat-num">{{ uploadResult.uploaded }}</div>
        <div class="stat-label">Uploaded</div>
      </div>
      <div class="stat-card fail-card">
        <div class="stat-num">{{ uploadResult.failed }}</div>
        <div class="stat-label">Failed</div>
      </div>
      <div class="stat-card total-card">
        <div class="stat-num">{{ uploadResult.total }}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card rate-card">
        <div class="stat-num">{{ getSuccessRate() }}%</div>
        <div class="stat-label">Success Rate</div>
      </div>
    </div>

    <!-- SUCCESS PROGRESS -->
    <div class="result-progress">
      <div class="progress-track">
        <div class="progress-fill"
          [style.width.%]="getSuccessRate()"
          [style.background]="uploadResult.failed === 0 ? '#22c55e' : '#f59e0b'">
        </div>
      </div>
      <span>{{ getSuccessRate() }}% success rate</span>
    </div>

    <!-- ERROR LIST -->
    <div class="error-list" *ngIf="uploadResult.errorList && uploadResult.errorList.length > 0">
      <h3>
        <mat-icon>error_outline</mat-icon>
        Failed Rows ({{ uploadResult.errorList.length }})
      </h3>
      <div class="error-table-wrap">
        <table class="error-table">
          <thead>
            <tr>
              <th>Row</th>
              <th>Contact</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let err of uploadResult.errorList">
              <td><span class="row-badge">{{ err.row }}</span></td>
              <td>{{ err.name }}</td>
              <td><span class="error-reason">{{ err.error }}</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="result-actions">
      <button class="btn-secondary" (click)="reset()">
        <mat-icon>upload_file</mat-icon>
        Upload More
      </button>
      <button class="btn-upload" (click)="goToContacts()">
        <mat-icon>people</mat-icon>
        View All Contacts
      </button>
    </div>

  </div>

</div>
